#!/bin/sh

CUR_DIR=$( cd $( dirname $0 ) && pwd )
VERSION=$(grep -E '^version' ${CUR_DIR}/../Cargo.toml | awk '{print $3}' | sed 's/"//g')

cd "$CUR_DIR/.."

## Disable OS X ACL file
export COPYFILE_DISABLE=1

function build() {
    TARGET=$1
    echo "* Building ${TARGET} package ${VERSION} ..."

    RELEASE_DIR="target/${TARGET}/release"
    PKG_NAME="shadowsocks-v${VERSION}-stable.${TARGET}.tar.xz"
    PKG_PATH="${CUR_DIR}/${PKG_NAME}"

    cross build --target "${TARGET}" \
                --features "miscreant" \
                --release

    if [[ $? != "0" ]]; then
        exit $?
    fi

    echo "* Packaging XZ in ${PKG_PATH} ..."
    cd ${RELEASE_DIR}
    tar -cJf ${PKG_PATH} \
        "sslocal" \
        "ssserver" \
        "ssurl" \
        "sstunnel"

    if [[ $? != "0" ]]; then
        exit $?
    fi

    echo "* Done build package ${PKG_NAME}"
}

build "x86_64-unknown-linux-musl"
#build "x86_64-pc-windows-gnu"